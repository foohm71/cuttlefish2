# Cuttlefish API (FastAPI Backend)

This folder contains the FastAPI backend for the Cuttlefish project. It provides endpoints for semantic similarity search and retrieval-augmented generation (RAG) using Qdrant and OpenAI.

## Features
- `/similar` — Returns the top 5 most similar entries from Qdrant for a given query.
- `/rag` — Returns an answer generated by OpenAI using the top 5 most similar entries as context (RAG).
- CORS enabled for frontend integration.

## Setup

1. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Configure environment variables:**
   Create a `.env` file in this folder (or project root) with:
   ```env
   QDRANT_URL=your_qdrant_url
   QDRANT_API_KEY=your_qdrant_api_key
   QDRANT_COLLECTION=jira_issues
   OPENAI_EMBED_MODEL=text-embedding-3-small
   OPENAI_RAG_MODEL=gpt-3.5-turbo
   ```

3. **Run the server locally:**
   - From the project root:
     ```bash
     uvicorn api.main:app --reload
     ```
   - Or from the `api` folder:
     ```bash
     uvicorn main:app --reload
     ```
   - The app uses [Mangum](https://github.com/jordaneremieff/mangum) for serverless compatibility, but this does not affect local usage.

## Deploying to Vercel (Serverless)

This API is compatible with Vercel serverless functions using Mangum.

1. **Project structure:**
   - Ensure your FastAPI app is in `api/main.py` and exports a `handler` variable:
     ```python
     from fastapi import FastAPI
     from mangum import Mangum
     app = FastAPI()
     # ... define routes ...
     handler = Mangum(app)
     ```
   - `vercel.json` should specify the Python runtime:
     ```json
     {
       "functions": {
         "main.py": {
           "runtime": "python3.9"
         }
       }
     }
     ```
   - All dependencies (including `mangum`) must be in `requirements.txt`.

2. **Deploy:**
   - Push your repo to GitHub/GitLab.
   - Import the project in [Vercel](https://vercel.com/).
   - Vercel will deploy the API as a serverless function at `/api/main`.
   - Set environment variables in the Vercel dashboard as needed.

3. **Usage:**
   - Your endpoints will be available at `https://<your-vercel-project>.vercel.app/api/main/similar` and `/api/main/rag`.

## API Endpoints

### POST `/similar`
- **Request JSON:**
  ```json
  {
    "query": "your search text",
    "openai_api_key": "sk-..."
  }
  ```
- **Response:**
  ```json
  {
    "results": [
      { "id": ..., "score": ..., "payload": { ... } },
      ...
    ]
  }
  ```

### POST `/rag`
- **Request JSON:**
  ```json
  {
    "query": "your search text",
    "openai_api_key": "sk-..."
  }
  ```
- **Response:**
  ```json
  {
    "answer": "...",
    "context": [
      { "id": ..., "score": ..., "payload": { ... } },
      ...
    ]
  }
  ```

## Testing
- Use the provided `test.sh` script or tools like curl/Postman to test endpoints.
- For local testing, ensure FastAPI is running with `uvicorn main:app --reload`.
- For Vercel, endpoints are available at `/api/main`.
- Make sure your backend is running and accessible from your frontend (CORS is enabled).

## Notes
- The OpenAI API key is provided per request for security and flexibility.
- Make sure your Qdrant instance is populated with data before using the endpoints. 