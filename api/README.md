# Cuttlefish API (FastAPI Backend)

This folder contains the FastAPI backend for the Cuttlefish project. It provides endpoints for semantic similarity search and retrieval-augmented generation (RAG) using Qdrant and OpenAI.

## Features
- `/similar` — Returns the top 5 most similar entries from Qdrant for a given query.
- `/rag` — Returns an answer generated by OpenAI using the top 5 most similar entries as context (RAG).
- CORS enabled for frontend integration.

## Setup

1. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Configure environment variables:**
   Create a `.env` file in this folder (or project root) with:
   ```env
   QDRANT_URL=your_qdrant_url
   QDRANT_API_KEY=your_qdrant_api_key
   QDRANT_COLLECTION=jira_issues
   OPENAI_EMBED_MODEL=text-embedding-3-small
   OPENAI_RAG_MODEL=gpt-3.5-turbo
   ```

3. **Run the server locally:**
   - From the project root:
     ```bash
     uvicorn api.main:app --reload
     ```
   - Or from the `api` folder:
     ```bash
     uvicorn main:app --reload
     ```

## Deploying to Render

This API is compatible with Render's free web service.

1. **Project structure:**
   - Ensure your FastAPI app is in `api/main.py` and your `requirements.txt` is in the same folder.

2. **Create a new Web Service on Render:**
   - Set the root directory to `api/` when connecting your repo.
   - Set the **Start Command** to:
     ```bash
     uvicorn main:app --host 0.0.0.0 --port 10000
     ```
   - Set environment variables in the Render dashboard as needed (see above).

3. **Deploy:**
   - Render will install dependencies and start your FastAPI app.
   - Your endpoints will be available at `https://<your-render-service>.onrender.com/similar` and `/rag`.

## API Endpoints

### POST `/similar`
- **Request JSON:**
  ```json
  {
    "query": "your search text",
    "openai_api_key": "sk-..."
  }
  ```
- **Response:**
  ```json
  {
    "results": [
      { "id": ..., "score": ..., "payload": { ... } },
      ...
    ]
  }
  ```

### POST `/rag`
- **Request JSON:**
  ```json
  {
    "query": "your search text",
    "openai_api_key": "sk-..."
  }
  ```
- **Response:**
  ```json
  {
    "answer": "...",
    "context": [
      { "id": ..., "score": ..., "payload": { ... } },
      ...
    ]
  }
  ```

## Testing
- Use the provided `test.sh` script for local testing, or `test-render.sh` for testing the deployed Render API.
- For local testing, ensure FastAPI is running with `uvicorn main:app --reload`.
- For Render, endpoints are available at your Render service URL (e.g., `https://<your-render-service>.onrender.com`).
- Make sure your backend is running and accessible from your frontend (CORS is enabled).

## test-render.sh

The `test-render.sh` script allows you to test your deployed Render API endpoints. It uses your Render service URL and your OpenAI API key to send test requests to `/similar` and `/rag` endpoints.

**Usage:**
1. Set your Render API URL and OpenAI API key at the top of the script, or load them from a `.env` file.
2. Run the script:
   ```bash
   ./test-render.sh
   ```
3. The script will print the results of both endpoints.

## Notes
- The OpenAI API key is provided per request for security and flexibility.
- Make sure your Qdrant instance is populated with data before using the endpoints. 